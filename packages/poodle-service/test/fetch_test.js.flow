/* @flow */

import * as json       from 'format-json'
import * as actions    from '../src/actions'
import * as google     from '../src/oauth/google'
import * as googletest from './oauth/google'
import * as promises   from '../src/util/promises'

const msgId = '55dad9e6.633e460a.c2b46.ffffce8f@mx.google.com'

export default function test() {
  return Promise.all([
    testFetchMessage(),
    testFetchMessagePart(),
  ])
}

async function testFetchMessage() {
  const tokGen = await googletest.getTokenGenerator()
  const conn   = await google.getConnection(tokGen)
  const msg    = await actions.fetchMessage(msgId, conn)

  console.log('downloaded message:')
  console.log(json.plain(msg))
  console.log('')
}

async function testFetchMessagePart() {
  const tokGen = await googletest.getTokenGenerator()
  const conn   = await google.getConnection(tokGen)
  const msg    = await actions.fetchMessage(msgId, conn)
  const part   = await actions.fetchMessagePart(msg, '1.2', conn)

  console.log('message part:')
  part.pipe(process.stdout)
  console.log('')

  return promises.lift0(cb => part.addListener('end', cb))
}
